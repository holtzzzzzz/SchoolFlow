<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <title>Boletim - Professor</title>
</head>
<body>
  <nav class="sidebar">
    <div class="sidebar-header">
      <img src="imgs/menu.png" alt="Menu">
      <h2>Professor</h2>
    </div>
    <div class="nav-links">
      <a href="indexProfessor.html"><img src="imgs/home.png" alt="Home">Início</a>
      <a href="desempenho.html"><img src="imgs/turma.png" alt="Class">Desempenho da Turma</a>
      <a href="#"><img src="imgs/faltas.png" alt="Faltas">Faltas</a>
      <a href="#"><img src="imgs/calendar.png" alt="Calendar">Calendário</a>
      <a href="boletimProfessor.html"><img src="imgs/grades.png" alt="Grades">Notas</a>
    </div>
  </nav>

  <div class="main-content">
    <div class="login-container">
      <h2>Lançamento de Notas</h2>

      <label for="turmaSelect">Selecione a Turma:</label>
      <select id="turmaSelect"></select>

      <button id="carregarBtn" class="login-button">Carregar Alunos</button>

      
    </div>
    <div id="boletim-container" style="margin-top:20px; display: none;"></div>
  </div>

  <script>
    const boletim = document.getElementById('boletim-container')
    const turmaSelect = document.getElementById('turmaSelect');
    const disciplinaSelect = document.getElementById('disciplinaSelect');
    const boletimContainer = document.getElementById('boletim-container');

    async function carregarTurmas() {
      const res = await fetch('/api/turmas');
      const turmas = await res.json();
      turmaSelect.innerHTML = '<option value="">Selecione a Turma</option>';
      turmas.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id_turma;
        opt.textContent = `${t.ano}º ${t.serie}`;
        turmaSelect.appendChild(opt);
      });
    }
    

    
    async function carregarDisciplinas() {
      const res = await fetch('/api/disciplinas');
      const disciplinas = await res.json();
      disciplinaSelect.innerHTML = '<option value="">Selecione a Disciplina</option>';
      disciplinas.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id_disciplina;
        opt.textContent = d.nome;
        disciplinaSelect.appendChild(opt);
      });
    }

    async function carregarAlunos() {
      const id_turma = turmaSelect.value;
      if (!id_turma) {
        alert('Selecione a turma!');
        return;
      }

      const res = await fetch(`/api/professor/alunos?id_turma=${id_turma}`);
      const data = await res.json();

      if (!data.alunos || data.alunos.length === 0) {
        boletimContainer.innerHTML = '<p>Nenhum aluno encontrado.</p>';
        boletimContainer.style.display = 'block'; 
        return;
      }

      const id_disciplina = data.id_disciplina;
      const alunos = data.alunos;

      let tabela = `
      <table border="1" cellpadding="4" cellspacing="0">
        <thead>
          <tr>
            <th>Aluno</th>
            <th>I1</th>
            <th>I2</th>
            <th>EPA</th>
            <th>N2</th>
            <th>N3</th>
            <th>Rec</th>
            <th>Faltas</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
    `;

    alunos.forEach(a => {
      tabela += `
        <tr>
          <td data-label="Aluno">${a.nome}</td>
          <td data-label="I1"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this)" id="i1-${a.id_aluno}" value="${a.i1 ?? ''}"></td>
          <td data-label="I2"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this)" id="i2-${a.id_aluno}" value="${a.i2 ?? ''}"></td>
          <td data-label="EPA"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this)" id="epa-${a.id_aluno}" value="${a.epa ?? ''}"></td>
          <td data-label="N2"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this)" id="n2-${a.id_aluno}" value="${a.n2 ?? ''}"></td>
          <td data-label="N3"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this)" id="n3-${a.id_aluno}" value="${a.n3 ?? ''}"></td>
          <td data-label="Rec"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this)" id="rec-${a.id_aluno}" value="${a.rec ?? ''}"></td>
          <td data-label="Faltas"><input class="inputtabela" type="number" step="1" min="0" id="faltas-${a.id_aluno}" value="${a.faltas ?? ''}"></td>
          <td data-label="Ações"><button onclick="salvarNota(${a.id_aluno}, ${id_disciplina})">Salvar</button></td>
        </tr>
      `;
    });


      tabela += `</tbody></table>`;
      boletimContainer.innerHTML = tabela;
      boletimContainer.style.display = 'block';
    }



    async function salvarNota(id_aluno, id_disciplina) {
      const payload = {
        id_aluno,
        id_disciplina,
        i1: document.getElementById(`i1-${id_aluno}`).value,
        i2: document.getElementById(`i2-${id_aluno}`).value,
        epa: document.getElementById(`epa-${id_aluno}`).value,
        n2: document.getElementById(`n2-${id_aluno}`).value,
        n3: document.getElementById(`n3-${id_aluno}`).value,
        rec: document.getElementById(`rec-${id_aluno}`).value,
        faltas: document.getElementById(`faltas-${id_aluno}`).value
      };

      const res = await fetch('/api/notas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      alert(data.message || 'Salvo com sucesso!');
    
    }

    function validarNota(input) {
      // Se o campo estiver vazio, não faz nada
      if (input.value.trim() === '') {
        return;
      }

      let valor = parseFloat(input.value);

      // Se não for um número válido (ex: "abc"), limpa o campo
      if (isNaN(valor)) {
        input.value = '';
        return;
      }

      // Regra 1: Se a nota for negativa, vira 0
      if (valor < 0) {
        valor = 0;
      } 
      // Regra 2: Se for maior que 10 E menor/igual a 100 (ex: 97), divide por 10
      else if (valor > 10 && valor <= 100) {
        valor = valor / 10;
      } 
      // Regra 3: Se for maior que 10 (ex: 11 ou 101), vira 10
      else if (valor > 10) {
        valor = 10;
      }

      // Arredonda para 2 casas decimais para evitar problemas com 0.3000000004
      valor = Math.round(valor * 100) / 100;

      // Atualiza o valor no campo
      input.value = valor;
    }
    document.getElementById('carregarBtn').addEventListener('click', carregarAlunos);

    // Inicializar selects
    carregarTurmas();
    carregarDisciplinas();
  </script>
</body>
</html>


