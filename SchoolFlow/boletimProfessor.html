<html lang="pt-BR">
<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1" />
   <link rel="stylesheet" href="styles.css" />
   <title>Boletim - Professor</title>
   <style>
      * {
         box-sizing: border-box;
         margin: 0;
         padding: 0;
      }

      body {
         font-family: Arial, sans-serif;
         background: #CBE0E9;
         min-height: 100vh;
      }

      /* ===== SIDEBAR ===== */
      nav.sidebar {
         position: fixed;
         top: 0;
         left: 0;
         width: 220px;
         height: 100vh;
         background: #f0f0f0;
         display: flex;
         flex-direction: column;
         padding: 24px 0;
         box-shadow: 2px 0 10px rgba(0,0,0,0.05);
         z-index: 100;
      }

      .sidebar-header {
         display: flex;
         align-items: center;
         padding: 0 24px 24px;
      }

      .sidebar-header img {
         height: 28px;
         width: 28px;
         margin-right: 10px;
      }

      .sidebar-header h2 {
         font-size: 1.3rem;
         color: #333;
      }

      .nav-links {
         display: flex;
         flex-direction: column;
         width: 100%;
         gap: 4px;
         padding: 0 12px;
      }

      .nav-links a {
         color: #333;
         text-decoration: none;
         padding: 12px;
         border-radius: 6px;
         font-size: 1rem;
         display: flex;
         align-items: center;
         font-weight: bold;
         transition: all 0.2s;
      }

      .nav-links a img {
         height: 20px;
         width: 20px;
         margin-right: 10px;
      }

      .nav-links a:hover {
         background-color: #555;
         color: #fff;
      }

      /* ===== MAIN CONTENT ===== */
      .main-content {
         margin-left: 220px;
         padding: 40px 32px;
         width: calc(100% - 220px);
         margin-right: 0;
         max-width: 100%;
      }

      .login-container {
         background: #fff;
         border-radius: 18px;
         box-shadow: 0 8px 32px rgba(42,93,124,0.10);
         padding: 40px 32px;
         margin: 0 auto 32px;
         max-width: 500px;
         width: 100%;
      }

      .login-container h2 {
         margin-bottom: 24px;
         color: black;
         font-weight: 700;
         font-size: 1.5rem;
         text-align: center;
      }

      label {
         display: block;
         margin-bottom: 8px;
         color: black;
         font-weight: 500;
      }

      select.inputtabela {
         width: 100%;
         padding: 10px 12px;
         margin-bottom: 16px;
         border: 1.5px solid #7a7a7a;
         border-radius: 8px;
         background: #f7fbfc;
         font-size: 1rem;
         color: #333;
      }

      select.inputtabela:focus {
         border-color: black;
         outline: none;
         box-shadow: 0 0 0 2px #b8b8b8;
      }

      .login-button {
         width: 100%;
         padding: 12px;
         background: linear-gradient(90deg, #7747ed 60%, #a385ee 100%);
         color: #fff;
         border: none;
         border-radius: 8px;
         font-size: 1.1rem;
         font-weight: 600;
         cursor: pointer;
         margin-top: 16px;
      }

      .login-button:hover {
         opacity: 0.9;
      }

      /* ===== TABELA ===== */
      #boletim-container {
         margin-top: 20px;
         background: #fff;
         padding: 20px;
         border-radius: 14px;
         box-shadow: 0 4px 12px rgba(0,0,0,0.08);
         width: 100%;
         overflow-x: auto;
      }

      table {
         border-collapse: collapse;
         width: 100%;
         min-width: 900px;
         background: #fff;
         border-radius: 12px;
         overflow: hidden;
         
      }

      th {
         background: linear-gradient(90deg, #7747ed, #a385ee);
         color: #fff;
         text-align: center;
         padding: 12px 8px;
         font-size: 0.95rem;
         font-weight: 600;
      }

      td {
         text-align: center;
         padding: 10px 8px;
         font-size: 0.9rem;
         color: #333;
         border-bottom: 1px solid #e0e0e0;
      }

      tr:nth-child(even) {
         background-color: #f9f9f9;
      }

      tr:hover {
         background: #f1f0ff;
      }

      .inputtabela {
         width: 70px;
         padding: 6px 8px;
         font-size: 0.9rem;
         text-align: center;
         border: 1.5px solid #ccc;
         border-radius: 6px;
         background: #fdfdfd;
      }

      .inputtabela:focus {
         border-color: #7747ed;
         outline: none;
         box-shadow: 0 0 0 2px rgba(119,71,237,0.25);
      }

      td button {
         padding: 8px 16px;
         background: linear-gradient(90deg, #7747ed, #a385ee);
         border: none;
         color: white;
         border-radius: 6px;
         cursor: pointer;
         font-size: 0.85rem;
         font-weight: 600;
      }

      td button:hover {
         opacity: 0.9;
      }

      /* ===== RESPONSIVIDADE MOBILE ===== */
      @media (max-width: 968px) {
         nav.sidebar {
            width: 100%;
            height: 70px;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
         }

         .sidebar-header {
            padding: 0;
         }

         .sidebar-header h2 {
            font-size: 1.1rem;
         }

         .nav-links {
            flex-direction: row;
            gap: 0;
            padding: 0;
         }

         .nav-links a {
            padding: 10px;
            font-size: 0;
         }

         .nav-links a img {
            margin: 0;
            height: 22px;
            width: 22px;
         }

         .main-content {
            margin-left: 0;
            margin-top: 90px;
            padding: 20px 16px;
            width: 100%;
         }

         .login-container {
            padding: 24px 20px;
            max-width: 100%;
         }

         #boletim-container {
            padding: 16px;
            overflow-x: visible;

         }

         table {
            display: block;
            min-width: 0;
         }

         thead {
            display: none;
         }

         tbody, tr {
            display: block;
         }

         tr {
            margin-bottom: 16px;
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
         }

         td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border: none;
            text-align: right;
         }

         td::before {
            content: attr(data-label);
            font-weight: 600;
            color: #555;
            text-align: left;
         }

         td:first-child {
            background: #f0f0f0;
            margin: -12px -12px 8px;
            padding: 12px;
            border-radius: 10px 10px 0 0;
            font-weight: bold;
         }

         .inputtabela {
            width: auto;
            min-width: 80px;
         }

         td button {
            width: 100%;
            margin-top: 8px;
         }
      }

      /* ===== RESPONSIVIDADE TABLET ===== */
      @media (min-width: 969px) and (max-width: 1400px) {
         .main-content {
            padding: 32px 24px;
         }

         table {
            min-width: 600px;
         }

         th, td {
            padding: 10px 6px;
            font-size: 0.85rem;
         }

         .inputtabela {
            width: 60px;
            padding: 5px 6px;
         }
      }
   </style>
</head>
<body>
   <nav class="sidebar">
      <div class="sidebar-header">
         <img src="imgs/menu.png" alt="Menu" />
         <h2>Professor</h2>
      </div>
      <div class="nav-links">
         <a href="indexProfessor.html"><img src="imgs/home.png" alt="Home" />Início</a>
         <a href="desempenho.html"><img src="imgs/turma.png" alt="Class" />Desempenho da Turma</a>
         <a href="#"><img src="imgs/faltas.png" alt="Faltas" />Faltas</a>
         <a href="#"><img src="imgs/calendar.png" alt="Calendar" />Calendário</a>
         <a href="boletimProfessor.html"><img src="imgs/grades.png" alt="Grades" />Notas</a>
      </div>
   </nav>

   <div class="main-content">
     <div style="max-width: 100%;" class="login-container">
         <h2>Lançamento de Notas</h2>
            <div style="background-color: transparent;flex: 1;flex-direction: row;height: 100%;">
              <div style="background-color: transparent; height: 0;">
                <label for="turmaSelect">Turma:</label>
                <select id="turmaSelect" class="inputtabela"></select>
              </div>
              <div style="background-color: transparent; height: 0;">
                <label for="trimestre-select">Trimestre:</label>
                <select id="trimestre-select" class="inputtabela">
                    <option value="1" selected>1º Trimestre</option>
                    <option value="2">2º Trimestre</option>
                    <option value="3">3º Trimestre</option>
                </select>
            
              </div>
            </div>
         <button id="carregarBtn" class="login-button" style="margin-top: 24px;">Carregar Alunos</button>
     </div>

     <div id="boletim-container" style="margin-top: 20px; display: none;height: 100%;"></div>
   </div>

   <script>
      const boletim = document.getElementById('boletim-container')
      const turmaSelect = document.getElementById('turmaSelect');
    // Note: A variável 'disciplinaSelect' foi removida pois não há <select> no HTML.
      const boletimContainer = document.getElementById('boletim-container');

      async function carregarTurmas() {
         const res = await fetch('/api/turmas');
         const turmas = await res.json();
         turmaSelect.innerHTML = '<option value="">Selecione a Turma</option>';
         turmas.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id_turma;
            opt.textContent = `${t.ano}º ${t.serie}`;
            turmaSelect.appendChild(opt);
         });
      }
      
    // Note: A função 'carregarDisciplinas' foi removida pois não é usada neste HTML.

      function calcularN1(i1, i2, epa) {
         const ins1 = Number(i1) || 0;
         const ins2 = Number(i2) || 0;
         const epa_ = Number(epa) || 0;
         
         // Se todos forem 0 ou vazios, retorna '-'
         if (ins1 === 0 && ins2 === 0 && epa_ === 0) return '-';
         
         return ((ins1 + ins2 + epa_) / 3).toFixed(2);
      }

      function calcularMP(n1, n2, n3) {
         const nota1 = Number(n1) || 0;
         const nota2 = Number(n2) || 0;
         const nota3 = Number(n3) || 0;
         
         // Se todos forem 0 ou vazios, retorna '-'
         if (nota1 === 0 && nota2 === 0 && nota3 === 0) return '-';
         
         return ((nota1 + nota2 + (nota3 * 2)) / 4).toFixed(2);
      }

    // =======================================================
    // FUNÇÃO ATUALIZADA (carregarAlunos)
    // =======================================================
      async function carregarAlunos() {
         const id_turma = turmaSelect.value;
      // Pega o valor do trimestre selecionado
      const id_trimestre = document.getElementById('trimestre-select').value; 

         if (!id_turma) {
            alert('Selecione a turma!');
            return;
         }

      // Adiciona o parâmetro 'trimestre' na requisição fetch
         const res = await fetch(`/api/professor/alunos?id_turma=${id_turma}&trimestre=${id_trimestre}`);
         const data = await res.json();

         if (!data.alunos || data.alunos.length === 0) {
            boletimContainer.innerHTML = '<p>Nenhum aluno encontrado.</p>';
            boletimContainer.style.display = 'block'; 
            return;
         }

         const id_disciplina = data.id_disciplina;
         const alunos = data.alunos;

         let tabela = `
         <table border="1" cellpadding="4" cellspacing="0">
            <thead>
               <tr>
                  <th>Aluno</th>
                  <th>I1</th>
                  <th>I2</th>
                  <th>EPA</th>
                  <th>N1</th>
                  <th>N2</th>
                  <th>N3</th>
                  <th>MP</th>
                  <th>Rec</th>
                  <th>Faltas</th>
                  <th>Ações</th>
               </tr>
            </thead>
            <tbody>
      `;

      alunos.forEach(a => {
         const n1 = calcularN1(a.i1, a.i2, a.epa);
         const mp = calcularMP(n1, a.n2, a.n3);
         
         tabela += `
            <tr>
               <td data-label="Aluno">${a.nome}</td>
               <td data-label="I1"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="i1-${a.id_aluno}" value="${a.i1 ?? ''}"></td>
               <td data-label="I2"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="i2-${a.id_aluno}" value="${a.i2 ?? ''}"></td>
               <td data-label="EPA"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="epa-${a.id_aluno}" value="${a.epa ?? ''}"></td>
               <td data-label="N1" id="n1-display-${a.id_aluno}" style="font-weight: bold; background-color: #f0f0f0;">${n1}</td>
               <td data-label="N2"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="n2-${a.id_aluno}" value="${a.n2 ?? ''}"></td>
               <td data-label="N3"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this); atualizarCalculos(${a.id_aluno})" id="n3-${a.id_aluno}" value="${a.n3 ?? ''}"></td>
               <td data-label="MP" id="mp-display-${a.id_aluno}" style="font-weight: bold; background-color: #f0f0f0;">${mp}</td>
               <td data-label="Rec"><input class="inputtabela" type="number" step="0.1" onblur="validarNota(this)" id="rec-${a.id_aluno}" value="${a.rec ?? ''}"></td>
               <td data-label="Faltas"><input class="inputtabela" type="number" step="1" min="0" id="faltas-${a.id_aluno}" value="${a.faltas ?? ''}"></td>
               <td data-label="Ações"><button onclick="salvarNota(${a.id_aluno}, ${id_disciplina})">Salvar</button></td>
            </tr>
         `;
      });


         tabela += `</tbody></table>`;
         boletimContainer.innerHTML = tabela;
         boletimContainer.style.display = 'block';
      }

      function atualizarCalculos(id_aluno) {
         const i1 = document.getElementById(`i1-${id_aluno}`).value;
         const i2 = document.getElementById(`i2-${id_aluno}`).value;
         const epa = document.getElementById(`epa-${id_aluno}`).value;
         const n2 = document.getElementById(`n2-${id_aluno}`).value;
         const n3 = document.getElementById(`n3-${id_aluno}`).value;

         // Calcula N1
         const n1 = calcularN1(i1, i2, epa);
         document.getElementById(`n1-display-${id_aluno}`).textContent = n1;

         // Calcula MP
         const mp = calcularMP(n1, n2, n3);
         document.getElementById(`mp-display-${id_aluno}`).textContent = mp;
      }

    // =======================================================
    // FUNÇÃO ATUALIZADA (salvarNota)
    // =======================================================
      async function salvarNota(id_aluno, id_disciplina) {
      // Pega o valor do trimestre selecionado
      const id_trimestre = document.getElementById('trimestre-select').value;

         const payload = {
            id_aluno,
            id_disciplina,
            i1: document.getElementById(`i1-${id_aluno}`).value,
            i2: document.getElementById(`i2-${id_aluno}`).value,
            epa: document.getElementById(`epa-${id_aluno}`).value,
            n2: document.getElementById(`n2-${id_aluno}`).value,
            n3: document.getElementById(`n3-${id_aluno}`).value,
            rec: document.getElementById(`rec-${id_aluno}`).value,
            faltas: document.getElementById(`faltas-${id_aluno}`).value,
        trimestre: id_trimestre // Inclui o trimestre no payload
         };

         const res = await fetch('/api/notas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
         });

         const data = await res.json();
         alert(data.message || 'Salvo com sucesso!');
      
      }

      function validarNota(input) {
         // Se o campo estiver vazio, não faz nada
         if (input.value.trim() === '') {
           return;
         }

         let valor = parseFloat(input.value);

         // Se não for um número válido (ex: "abc"), limpa o campo
         if (isNaN(valor)) {
            input.value = '';
            return;
         }

         // Regra 1: Se a nota for negativa, vira 0
         if (valor < 0) {
            valor = 0;
         } 
         // Regra 2: Se for maior que 10 E menor/igual a 100 (ex: 97), divide por 10
         else if (valor > 10 && valor <= 100) {
            valor = valor / 10;
         } 
         // Regra 3: Se for maior que 10 (ex: 11 ou 101), vira 10
         else if (valor > 10) {
            valor = 10;
         }

         // Arredonda para 2 casas decimais para evitar problemas com 0.3000000004
         valor = Math.round(valor * 100) / 100;

         // Atualiza o valor no campo
         input.value = valor;
      }

      document.getElementById('carregarBtn').addEventListener('click', carregarAlunos);

      // Inicializar selects
      carregarTurmas();
    // A chamada 'carregarDisciplinas()' foi removida.
   </script>
</body>
</html>
