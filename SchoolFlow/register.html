<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <title>Registrar Usuário</title>
</head>
<body style="justify-content: center; display: flex; align-items: center;">
  <nav class="sidebar">
    <div class="sidebar-header">
      <img src="imgs/menu.png" alt="Menu">
    </div>
    <div class="nav-links">
      <a href="indexSecretaria.html"><img src="imgs/home.png" alt="Home">Início</a>
      <a href="register.html"><img src="imgs/registro.png" alt="Register">Registrar Usuários</a>
      <a href="#"><img src="imgs/turma.png" alt="Class">Desempenho da Turma</a>
      <a href="#"><img src="imgs/paperplane.png" alt="Message">Mensagens</a>
      <a href="#"><img src="imgs/bell.png" alt="Bell">Avisos</a>
      <a href="#"><img src="imgs/calendar.png" alt="Calendar">Calendário</a>
      <a href="#"><img src="imgs/grades.png" alt="Grades">Notas</a>
    </div>
  </nav>
  
  <div class="login-container">
    <img src="imgs/logo.png" alt="Logo" />
    <h2>Cadastro de Usuário</h2>
    <select id="tipoCadastro">
      <option value="">Selecione</option>
      <option value="aluno">Aluno</option>
      <option value="professor">Professor</option>
      <option value="responsavel">Responsável</option>
      <option value="secretaria">Secretaria</option>
    </select>
    
    <!-- Formulário -->
    <form id="registerForm" action="/register" method="POST" style="margin-top: 20px;">
      <input type="hidden" name="funcao" id="funcao" />
      <input type="text" name="nome" placeholder="Nome Completo" required /><br />
      <input type="email" name="email" placeholder="Email" required /><br />
      <input type="password" name="password" placeholder="Senha" required /><br />

      <!-- Turma (para aluno) -->
      <select name="id_turma" id="id_turma" style="display:none;">
        <option value="">Selecione a Turma</option>
      </select><br />

      <!-- Disciplina (para professor) -->
      <select name="id_disciplina" id="id_disciplina" style="display:none;">
        <option value="">Selecione a Disciplina</option>
      </select><br />

      <!-- Turmas (para professor - múltiplo) -->
      <select name="id_turmas[]" id="id_turmas" multiple style="display:none; height: 100px;" >
      </select><br />

      <!-- Código (para secretaria) -->
      <input type="text" name="codigo" id="codigo" placeholder="Código (apenas para Secretaria)" style="display:none;" /><br />

      <button class="login-button" type="submit">Registrar</button>
    </form>
  </div>

  <script>
    const tipoCadastro = document.getElementById('tipoCadastro');
    const funcaoInput = document.getElementById('funcao');
    const turmaSelect = document.getElementById('id_turma');
    const disciplinaSelect = document.getElementById('id_disciplina');
    const turmasMulti = document.getElementById('id_turmas');
    const codigoInput = document.getElementById('codigo');

    // Carregar turmas
    async function carregarTurmas() {
      try {
        const response = await fetch('/api/turmas');
        const turmas = await response.json();
        
        // Para aluno
        turmaSelect.innerHTML = '<option value="">Selecione a Turma</option>';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t.id_turma;
          option.textContent = `${t.ano}º ${t.serie}`;
          turmaSelect.appendChild(option);
        });

        // Para professor (multi)
        turmasMulti.innerHTML = '';
        turmas.forEach(t => {
          const option = document.createElement('option');
          option.value = t.id_turma;
          option.textContent = `${t.ano}º ${t.serie}`;
          turmasMulti.appendChild(option);
        });

      } catch (error) {
        console.error('Erro ao carregar turmas:', error);
      }
    }

    // Carregar disciplinas
    async function carregarDisciplinas() {
      try {
        const response = await fetch('/api/disciplinas');
        const disciplinas = await response.json();
        disciplinaSelect.innerHTML = '<option value="">Selecione a Disciplina</option>';
        disciplinas.forEach(d => {
          const option = document.createElement('option');
          option.value = d.id_disciplina;
          option.textContent = d.nome;
          disciplinaSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar disciplinas:', error);
      }
    }

    carregarTurmas();
    carregarDisciplinas();

    tipoCadastro.addEventListener('change', function() {
      funcaoInput.value = this.value;

      turmaSelect.style.display = 'none';
      disciplinaSelect.style.display = 'none';
      turmasMulti.style.display = 'none';
      codigoInput.style.display = 'none';

      if (this.value === 'aluno') {
        turmaSelect.style.display = '';
      } else if (this.value === 'professor') {
        disciplinaSelect.style.display = '';
        turmasMulti.style.display = '';
      } else if (this.value === 'secretaria') {
        codigoInput.style.display = '';
      }
    });

    const registerForm = document.getElementById('registerForm');
    registerForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      if (!tipoCadastro.value) {
        alert('Selecione o tipo de cadastro!');
        return;
      }

      const formData = new FormData(registerForm);
      let data = Object.fromEntries(formData);

      // Pegar múltiplas turmas do professor
      if (tipoCadastro.value === 'professor') {
        const selected = Array.from(turmasMulti.selectedOptions).map(o => o.value);
        data.id_turmas = selected;
      }

      try {
        const response = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const responseData = await response.json();

        if (response.ok) {
          alert(responseData.message);
          registerForm.reset();
          tipoCadastro.value = '';
          funcaoInput.value = '';
          turmaSelect.style.display = 'none';
          disciplinaSelect.style.display = 'none';
          turmasMulti.style.display = 'none';
          codigoInput.style.display = 'none';
        } else {
          alert(responseData.message);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao conectar com o servidor');
      }
    });
  </script>
</body>
</html>
