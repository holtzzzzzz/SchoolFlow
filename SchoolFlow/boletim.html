<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css">
    <title>Boletim Escolar - SchoolFlow</title>
  </head>    
  <body>
    <nav class="sidebar">
      <div class="sidebar-header">
        <img src="imgs/menu.png" alt="Menu">
      </div>
      <div class="nav-links">
        <a href="index.html"><img src="imgs/home.png" alt="Home">Início</a>
        <a href="boletim.html"><img src="imgs/book.png" alt="Book">Boletim</a>
        <a href="#"><img src="imgs/turma.png" alt="Class">Desempenho da Turma</a>
        <a href="#"><img src="imgs/paperplane.png" alt="Message">Mensagens</a>
        <a href="#"><img src="imgs/bell.png" alt="Bell">Avisos</a>
        <a href="#"><img src="imgs/calendar.png" alt="Calendar">Calendário</a>
      </div>  
    </nav>
    <main class="main-content">
      <div>
        <h2>Nome: <span id="aluno-nome"></span></h2>
        <h2>Turma: <span id="aluno-turma"></span></h2>
        <h2>Matrícula: <span id="aluno-matricula"></span></h2>
        <label for="alunoIdInput">ID do Aluno:</label>
        <input type="text" id="alunoIdInput" value="3" />
        <button id="buscarBtn">Buscar Boletim</button>

      </div>
      <table>
        <thead>
          <tr>
            <th>Matéria</th>
            <th>I1</th>
            <th>I2</th>
            <th>EPA</th>
            <th>N1</th>
            <th>N2</th>
            <th>N3</th>
            <th>MP</th>
            <th>REC</th>
            <th>MT</th>
            <th>faltas</th>
          </tr>
        </thead>
        <tbody id="boletim-tbody">

        </tbody>
      </table>
      <script>
        // Função para calcular a média parcial com conversão segura
        function calcularMediaParcial(n1, n2, n3) {
          const nota1 = Number(n1) || 0;
          const nota2 = Number(n2) || 0;
          const nota3 = Number(n3) || 0;
          return (nota1 + nota2 + (nota3 * 2)) / 4;
        }
      
        // Função para calcular a média total com base na MP e REC
        function calcularMediaTotal(mp, rec) {
          const mediaParcial = Number(mp) || 0;
          const recuperacao = Number(rec) || 0;
      
          if (mediaParcial >= 6) return mediaParcial  ;
          let mt = Math.max(mediaParcial, recuperacao);
          return mt > 6 ? 6 : mt;
        }
        function N1(epa, i1, i2){
          const ins1 = Number(i1)
          const ins2 = Number(i2)
          const epa_ = Number(epa)
          let n1 = (ins1 + ins2 + epa_)/3
          return n1
        }

        // Função principal de busca do boletim
        async function buscarBoletim() {
          const alunoId = document.getElementById('alunoIdInput').value;
          const nomeSpan = document.getElementById('aluno-nome');
          const turmaSpan = document.getElementById('aluno-turma');
          const matriculaSpan = document.getElementById('aluno-matricula');
          const tbody = document.getElementById('boletim-tbody');
      
          try {
            const response = await fetch(`/api/boletim?alunoId=${alunoId}`);
            if (!response.ok)
              throw new Error(`Erro ao buscar boletim: ${response.status} ${response.statusText}`);
      
            const data = await response.json();
      
            // Preencher dados do aluno
            nomeSpan.textContent = data.nome || '---';
            turmaSpan.textContent = data.turma || '---';
            matriculaSpan.textContent = data.matricula || '---';
      
            // Limpa o conteúdo atual da tabela
            tbody.innerHTML = '';
      
            // Preencher a tabela com as notas
            (data.notas || []).forEach(item => {
              const n1 = N1(item.epa, item.i1, item.i2)
              const mp = calcularMediaParcial(n1, item.n2, item.n3);
              const mt = calcularMediaTotal(mp, item.rec);
              const row = document.createElement('tr');
              var rec_ = Number(item.rec)
              if (mp > 6){
                rec_ = String(rec_)
                rec_ = '-'
              }
              row.innerHTML = `
                <td>${item.materia}</td>
                <td>${item.i1 ?? '-'}</td>
                <td>${item.i2 ?? '-'}</td>
                <td>${item.epa ?? '-'}</td>
                <td>${n1.toFixed(2)}</td>
                <td>${item.n2 ?? '-'}</td>
                <td>${item.n3 ?? '-'}</td>
                <td>${mp.toFixed(2)}</td>
                <td>${rec_}</td>
                <td>${mt.toFixed(2)}</td>
                <td>${item.faltas ?? '-'}</td>
              `;
              tbody.appendChild(row);
            });
      
          } catch (error) {
            alert(`Erro: ${error.message}`);
          }
        }
        // Adiciona evento ao botão
        document.getElementById('buscarBtn').addEventListener('click', buscarBoletim);
        // Carrega boletim automaticamente ao abrir a página
        window.addEventListener('load', buscarBoletim);
      </script>

    </main>
  </body>
</html>
